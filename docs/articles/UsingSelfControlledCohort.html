<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using SelfControlledCohort • SelfControlledCohort</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using SelfControlledCohort">
<meta property="og:description" content="SelfControlledCohort">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SelfControlledCohort</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/UsingSelfControlledCohort.html">Using SelfControlledCohort</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link">hadesLogo</a>
</li>
<li>
  <a href="https://github.com/OHDSI/SelfControlledCohort/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using SelfControlledCohort</h1>
            
            <h4 data-toc-skip class="date">2022-01-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/SelfControlledCohort/blob/HEAD/vignettes/UsingSelfControlledCohort.Rmd" class="external-link"><code>vignettes/UsingSelfControlledCohort.Rmd</code></a></small>
      <div class="hidden name"><code>UsingSelfControlledCohort.Rmd</code></div>

    </div>

    
    
<style type="text/css">
h1  {
  margin-top: 60px;
}
</style>
<p>The Self Controlled Cohort method measures the association between an exposure and an outcome by comparing the number of outcomes during an unexposed time at risk to the number of outcomes during an exposed time at risk. The method is called “Self-Controlled” because each individual in the study contributes person-time to both the exposed and unexposed cohorts. Since each person contributes both exposed and unexposed time to the study only persons who experience the exposure can be used. The inputs to the analysis are the exposures and outcomes of interest, the unexposed time at risk and exposed time at risk dates for each person, and various analysis parameter settings that will be discussed in more detail.</p>
<p>There are seven time points to consider when defining this analysis.</p>
<div class="figure">
<img src="ExposureWindowsDiagram.png" alt=""><p class="caption">Figure: example exposure windows</p>
</div>
<p>For each exposure-outcome pair the following statistics are calculated:</p>
<ul>
<li><p>Number of persons with the exposure</p></li>
<li><p>Total number of exposures (A person can experience the exposure multiple times.)</p></li>
<li><p>Number of outcomes during the exposed time at risk</p></li>
<li><p>Number of outcomes during the unexposed time at risk</p></li>
<li><p>Total exposed person-time at risk</p></li>
<li><p>Total unexposed person-time at risk</p></li>
<li><p>Incidence rate ratio (incidence rate during exposed time)/(incidence rate during unexposed time) -</p></li>
<li><p>95% confidence interval for the incidence rate ratio</p></li>
<li><p>The log of the incidence rate ratio - The standard error of the log incidence rate ratio</p></li>
</ul>
<p>Each person’s exposure start date is taken as the index date or <em>Time 0</em>. The unexposed risk window is defined prior to Time 0 and represents a duration of time when the person was not exposed but could have experienced the outcome. The exposed risk window is defined as a period of time after the Time 0 and represents a duration of time when the person was exposed and could have experienced the outcome. Both of these time windows must be contained within a continuous period of observation. The details about when the risk windows start and end can be adjusted to meet the analysis specifications.</p>
<p>The time between the start of the observation period and Time 0 is called the washout period and a minimum allowed washout period can be set when defining the analysis. Similarly the time between Time 0 and the observation period end date is the followup period. A minimum followup period can also be set.</p>
<p>A common type of exposure is exposure to a drug but an exposure could be any set of characteristics that are captured in your data. We will look at a few different ways to define exposures.</p>
<div class="section level1">
<h1 id="tables-used-in-the-analysis">Tables used in the analysis<a class="anchor" aria-label="anchor" href="#tables-used-in-the-analysis"></a>
</h1>
<p>There are two primary tables needed for the self controlled cohort analysis along with a few supporting tables that are part of the OMOP Common Data Model.</p>
<center>
<strong>Exposure Table</strong>
</center>
<table style="width:53%;" class="table">
<colgroup>
<col width="29%">
<col width="23%">
</colgroup>
<thead><tr class="header">
<th>Field</th>
<th>Data type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>person_id</td>
<td>Integer</td>
</tr>
<tr class="even">
<td>e xposure_concept_id</td>
<td>Integer</td>
</tr>
<tr class="odd">
<td>e xposure_start_date</td>
<td>Date</td>
</tr>
<tr class="even">
<td>exposure_end_date</td>
<td>Date</td>
</tr>
</tbody>
</table>
<center>
<strong>Outcome Table</strong>
</center>
<table style="width:53%;" class="table">
<colgroup>
<col width="29%">
<col width="23%">
</colgroup>
<thead><tr class="header">
<th>Field</th>
<th>Data type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>person_id</td>
<td>Integer</td>
</tr>
<tr class="even">
<td>outcome_concept_id</td>
<td>Integer</td>
</tr>
<tr class="odd">
<td>outcome_start_date</td>
<td>Date</td>
</tr>
</tbody>
</table>
<p>These tables can be created manually or standard CDM tables can be used. For example by default the drug_era is used as the exposure_table and the condition_era table is used as the outcome_table. Every exposure-outcome combination in these tables will be included in the analysis unless otherwise specified. The additional CDM tables that are required for this analysis are <code>observation_period</code>, necessary for observation start and end dates, and <code>person</code>, necessary for year of birth.</p>
</div>
<div class="section level1">
<h1 id="a-first-example">A first example<a class="anchor" aria-label="anchor" href="#a-first-example"></a>
</h1>
<p>The SelfControlledCohort package makes it easy to calculate the association between every drug and every condition in a CDM database. The Eunomia package provides a mini CDM that runs entirely within R that we can use for examples.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="va">result</span><span class="op">$</span><span class="va">estimates</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">irr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;       exposureId outcomeId numPersons numExposures numOutcomesExposed</span>
<span class="co">#&gt; 1.119     705944   4048695         66           66                  1</span>
<span class="co">#&gt; 1.131     705944   4134304         66           66                  1</span>
<span class="co">#&gt; 1.139     705944   4230399         66           66                  1</span>
<span class="co">#&gt; 1.147     705944   4296204         66           66                  1</span>
<span class="co">#&gt; 1.152     705944  40479768         66           66                  1</span>
<span class="co">#&gt; 1.538     740275   4146173         42           42                  1</span>
<span class="co">#&gt;       numOutcomesUnexposed timeAtRiskExposed timeAtRiskUnexposed irr    irrLb95</span>
<span class="co">#&gt; 1.119                    0         306.71869            703.4853 Inf 0.05880986</span>
<span class="co">#&gt; 1.131                    0         306.71869            703.4853 Inf 0.05880986</span>
<span class="co">#&gt; 1.139                    0         306.71869            703.4853 Inf 0.05880986</span>
<span class="co">#&gt; 1.147                    0         306.71869            703.4853 Inf 0.05880986</span>
<span class="co">#&gt; 1.152                    0         306.71869            703.4853 Inf 0.05880986</span>
<span class="co">#&gt; 1.538                    0          30.78713            703.9316 Inf 0.58626854</span>
<span class="co">#&gt;       irrUb95 logRr seLogRr   p</span>
<span class="co">#&gt; 1.119     Inf   Inf     Inf NaN</span>
<span class="co">#&gt; 1.131     Inf   Inf     Inf NaN</span>
<span class="co">#&gt; 1.139     Inf   Inf     Inf NaN</span>
<span class="co">#&gt; 1.147     Inf   Inf     Inf NaN</span>
<span class="co">#&gt; 1.152     Inf   Inf     Inf NaN</span>
<span class="co">#&gt; 1.538     Inf   Inf     Inf NaN</span></code></pre></div>
<p>The result of our analysis is a dataframe with one row per exposure-outcome pair along with all the relevant statistics. Let’s interpret the results for amoxicillin exposure (concept ID 1713332) and the outcome of Chronic sinusitis (concept ID 257012)</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">example</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">estimates</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">exposureId</span> <span class="op">==</span> <span class="fl">1713332</span>, <span class="va">outcomeId</span> <span class="op">==</span> <span class="fl">257012</span><span class="op">)</span> 

<span class="va">example</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">value</span>,<span class="fl">1</span><span class="op">)</span>, scientific <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>column <span class="op">=</span> <span class="va">key</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>align <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lr"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">column</th>
<th align="right">value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">exposureId</td>
<td align="right">1713332.0</td>
</tr>
<tr class="even">
<td align="left">outcomeId</td>
<td align="right">257012.0</td>
</tr>
<tr class="odd">
<td align="left">numPersons</td>
<td align="right">2130.0</td>
</tr>
<tr class="even">
<td align="left">numExposures</td>
<td align="right">2130.0</td>
</tr>
<tr class="odd">
<td align="left">numOutcomesExposed</td>
<td align="right">65.0</td>
</tr>
<tr class="even">
<td align="left">numOutcomesUnexposed</td>
<td align="right">224.0</td>
</tr>
<tr class="odd">
<td align="left">timeAtRiskExposed</td>
<td align="right">277.4</td>
</tr>
<tr class="even">
<td align="left">timeAtRiskUnexposed</td>
<td align="right">45796.0</td>
</tr>
<tr class="odd">
<td align="left">irr</td>
<td align="right">47.9</td>
</tr>
<tr class="even">
<td align="left">irrLb95</td>
<td align="right">35.8</td>
</tr>
<tr class="odd">
<td align="left">irrUb95</td>
<td align="right">63.4</td>
</tr>
<tr class="even">
<td align="left">logRr</td>
<td align="right">3.9</td>
</tr>
<tr class="odd">
<td align="left">seLogRr</td>
<td align="right">0.1</td>
</tr>
<tr class="even">
<td align="left">p</td>
<td align="right">0.0</td>
</tr>
</tbody>
</table>
<p>We can see that 2130 were exposed to amoxicillin. When we add up all the time before the exposure we get 4.5796044^{4} person-years. Similarly when we add up all the time after the exposure, the “Exposed time at risk”, we get 277.4428474 person-years.</p>
<p>The incidence of Chronic sinusitis during the “Unexposed time at risk” is</p>
<p><span class="math display">\[
\frac{224 \ \ events}{45796.0 \ \ person \ years} =  0.00489
\]</span></p>
<p>The incidence of Chronic sinusitis during the “Exposed time at risk” is</p>
<p><span class="math display">\[
\frac{65 \ \ events}{277.4 \ \ person \ years} =  0.234
\]</span></p>
<p>The incidence rate ratio is <span class="math display">\[
\frac{234}{0.00489} = 47.9
\]</span> with a 95% confidence interval of <span class="math inline">\([35.8, 63.4]\)</span> See <code><a href="https://cran.rstudio.com/web/packages/rateratio.test/vignettes/rateratio.test.pdf" class="external-link">vignette("rateratio.test", package = "rateratio.test")</a></code> for method details.</p>
</div>
<div class="section level1">
<h1 id="custom-exposure-outcome-pairs">Custom exposure-outcome pairs<a class="anchor" aria-label="anchor" href="#custom-exposure-outcome-pairs"></a>
</h1>
<p>In addition to using all drugs as exposures and all conditions as outcomes we can come up with much more specific definitions of exposures and outcomes using cohorts. A cohort is a set of persons who satisfy one or more inclusion criteria for a duration of time. We can define cohorts using Atlas or by writing SQL code. If we use Atlas then the cohort will be stored in the Atlas “results” schema associated with your CDM database. If you want to write SQL then you will need write access to a schema in your CDM database.</p>
<p>We will simulate using cohorts created in Atlas by using the pre-built cohorts in Eunomia.</p>
<p>Suppose we are interested in the exposure of NSAID (cohort #4) and the outcome of GiBleed (cohort #3). Even though this is a drug-condition pair these cohorts could be defined using combinations of data elements from any domain.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span><span class="op">$</span><span class="va">estimates</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">exposureId</span> <span class="op">==</span> <span class="fl">4</span>, <span class="va">outcomeId</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">value</span>,<span class="fl">1</span><span class="op">)</span>, scientific <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>column <span class="op">=</span> <span class="va">key</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>align <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lr"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">column</th>
<th align="right">value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">exposureId</td>
<td align="right">4.0</td>
</tr>
<tr class="even">
<td align="left">outcomeId</td>
<td align="right">3.0</td>
</tr>
<tr class="odd">
<td align="left">numPersons</td>
<td align="right">2630.0</td>
</tr>
<tr class="even">
<td align="left">numExposures</td>
<td align="right">2630.0</td>
</tr>
<tr class="odd">
<td align="left">numOutcomesExposed</td>
<td align="right">159.0</td>
</tr>
<tr class="even">
<td align="left">numOutcomesUnexposed</td>
<td align="right">0.0</td>
</tr>
<tr class="odd">
<td align="left">timeAtRiskExposed</td>
<td align="right">215.7</td>
</tr>
<tr class="even">
<td align="left">timeAtRiskUnexposed</td>
<td align="right">101570.7</td>
</tr>
<tr class="odd">
<td align="left">irr</td>
<td align="right">Inf</td>
</tr>
<tr class="even">
<td align="left">irrLb95</td>
<td align="right">20057.5</td>
</tr>
<tr class="odd">
<td align="left">irrUb95</td>
<td align="right">Inf</td>
</tr>
<tr class="even">
<td align="left">logRr</td>
<td align="right">Inf</td>
</tr>
<tr class="odd">
<td align="left">seLogRr</td>
<td align="right">Inf</td>
</tr>
<tr class="even">
<td align="left">p</td>
<td align="right">NaN</td>
</tr>
</tbody>
</table>
<p>In this case the risk of being in the GI Bleed cohort before entering the exposure cohort is zero which means our rate ratio is infinite.</p>
<p>Even though this example uses a drug-condition pair for the exposure and the outcome, it demonstrates how we can use any cohorts created in Atlas as exposures and outcomes in a self controlled cohort study.</p>
<p>Let’s demonstrate custom exposure outcome pairs using SQL by asking “Do patients tend to get more measurements in the year after a condition diagnosis than the year before?”</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span>
<span class="co">#&gt; Connecting using SQLite driver</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- create outcome table</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> measurement_cohort <span class="kw">as</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  person_id <span class="kw">as</span> subject_id,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="kw">as</span> cohort_definition_id, <span class="co">-- treat any measurement as the same outcome</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  measurement_date <span class="kw">as</span> cohort_start_date,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  measurement_date <span class="kw">as</span> cohort_end_date</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> measurement</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- create exposure table</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> condition_cohort <span class="kw">as</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  person_id <span class="kw">as</span> subject_id,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span> <span class="kw">as</span> cohort_definition_id, <span class="co">-- treat any condition as the same exposure</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  condition_start_date <span class="kw">as</span> cohort_start_date,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  condition_end_date <span class="kw">as</span> cohort_end_date</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> condition_occurrence</span></code></pre></div>
<p>Using the <code>riskWindow</code> arguments we can set the time at risk to one year before and one year after each condition exposure.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span><span class="op">$</span><span class="va">estimates</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">value</span>,<span class="fl">1</span><span class="op">)</span>, scientific <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>column <span class="op">=</span> <span class="va">key</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>align <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lr"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">column</th>
<th align="right">value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">exposureId</td>
<td align="right">2.0</td>
</tr>
<tr class="even">
<td align="left">outcomeId</td>
<td align="right">1.0</td>
</tr>
<tr class="odd">
<td align="left">numPersons</td>
<td align="right">2689.0</td>
</tr>
<tr class="even">
<td align="left">numExposures</td>
<td align="right">2689.0</td>
</tr>
<tr class="odd">
<td align="left">numOutcomesExposed</td>
<td align="right">393.0</td>
</tr>
<tr class="even">
<td align="left">numOutcomesUnexposed</td>
<td align="right">73.0</td>
</tr>
<tr class="odd">
<td align="left">timeAtRiskExposed</td>
<td align="right">6153.4</td>
</tr>
<tr class="even">
<td align="left">timeAtRiskUnexposed</td>
<td align="right">4478.1</td>
</tr>
<tr class="odd">
<td align="left">irr</td>
<td align="right">3.9</td>
</tr>
<tr class="even">
<td align="left">irrLb95</td>
<td align="right">3.0</td>
</tr>
<tr class="odd">
<td align="left">irrUb95</td>
<td align="right">5.1</td>
</tr>
<tr class="even">
<td align="left">logRr</td>
<td align="right">1.4</td>
</tr>
<tr class="odd">
<td align="left">seLogRr</td>
<td align="right">0.1</td>
</tr>
<tr class="even">
<td align="left">p</td>
<td align="right">0.0</td>
</tr>
</tbody>
</table>
<p>Indeed it does appear that in Eunomia patients tend to get more tests after a diagnosis than before.</p>
</div>
<div class="section level1">
<h1 id="running-multiple-analyses">Running multiple analyses<a class="anchor" aria-label="anchor" href="#running-multiple-analyses"></a>
</h1>
<p>The SelfControlledCohort package supports performing multiple analyses at once and provides functions to specify the details of each analysis to be performed.</p>
<p>Start by creating an sccAnalysis object for each analysis type to be performed. We will create one analysis that uses 30 day exposure windows and another with 365 day exposure windows.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">    
<span class="va">sccArgs1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createRunSelfControlledCohortArgs.html">createRunSelfControlledCohortArgs</a></span><span class="op">(</span>firstExposureOnly <span class="op">=</span> <span class="cn">TRUE</span>,
                                              firstOutcomeOnly <span class="op">=</span> <span class="cn">TRUE</span>,
                                              minAge <span class="op">=</span> <span class="st">""</span>,
                                              maxAge <span class="op">=</span> <span class="st">""</span>,
                                              studyStartDate <span class="op">=</span> <span class="st">""</span>,
                                              studyEndDate <span class="op">=</span> <span class="st">""</span>,
                                              addLengthOfExposureExposed <span class="op">=</span> <span class="cn">TRUE</span>,
                                              riskWindowStartExposed <span class="op">=</span> <span class="fl">1</span>,
                                              riskWindowEndExposed <span class="op">=</span> <span class="fl">30</span>,
                                              addLengthOfExposureUnexposed <span class="op">=</span> <span class="cn">TRUE</span>,
                                              riskWindowEndUnexposed <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,
                                              riskWindowStartUnexposed <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>,
                                              hasFullTimeAtRisk <span class="op">=</span> <span class="cn">FALSE</span>,
                                              computeTarDistribution <span class="op">=</span> <span class="cn">TRUE</span>,
                                              washoutPeriod <span class="op">=</span> <span class="fl">0</span>,
                                              followupPeriod <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>

<span class="va">sccArgs2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createRunSelfControlledCohortArgs.html">createRunSelfControlledCohortArgs</a></span><span class="op">(</span>firstExposureOnly <span class="op">=</span> <span class="cn">TRUE</span>,
                                              firstOutcomeOnly <span class="op">=</span> <span class="cn">TRUE</span>,
                                              minAge <span class="op">=</span> <span class="st">""</span>,
                                              maxAge <span class="op">=</span> <span class="st">""</span>,
                                              studyStartDate <span class="op">=</span> <span class="st">""</span>,
                                              studyEndDate <span class="op">=</span> <span class="st">""</span>,
                                              addLengthOfExposureExposed <span class="op">=</span> <span class="cn">TRUE</span>,
                                              riskWindowStartExposed <span class="op">=</span> <span class="fl">1</span>,
                                              riskWindowEndExposed <span class="op">=</span> <span class="fl">365</span>,
                                              addLengthOfExposureUnexposed <span class="op">=</span> <span class="cn">TRUE</span>,
                                              riskWindowEndUnexposed <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,
                                              riskWindowStartUnexposed <span class="op">=</span> <span class="op">-</span><span class="fl">365</span>,
                                              hasFullTimeAtRisk <span class="op">=</span> <span class="cn">FALSE</span>,
                                              computeTarDistribution <span class="op">=</span> <span class="cn">TRUE</span>,
                                              washoutPeriod <span class="op">=</span> <span class="fl">0</span>,
                                              followupPeriod <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>

<span class="va">sccAnalysis1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createSccAnalysis.html">createSccAnalysis</a></span><span class="op">(</span>analysisId <span class="op">=</span> <span class="fl">1</span>,
                              description <span class="op">=</span> <span class="st">"30 day risk windows"</span>,
                              exposureType <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># What are the valid values for this argument?</span>
                              outcomeType <span class="op">=</span> <span class="cn">NULL</span>,
                              runSelfControlledCohortArgs <span class="op">=</span> <span class="va">sccArgs1</span><span class="op">)</span>


<span class="va">sccAnalysis2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createSccAnalysis.html">createSccAnalysis</a></span><span class="op">(</span>analysisId <span class="op">=</span> <span class="fl">2</span>,
                              description <span class="op">=</span> <span class="st">"365 day risk windows"</span>,
                              exposureType <span class="op">=</span> <span class="cn">NULL</span>,
                              outcomeType <span class="op">=</span> <span class="cn">NULL</span>,
                              runSelfControlledCohortArgs <span class="op">=</span> <span class="va">sccArgs1</span><span class="op">)</span>

<span class="va">sccAnalysisList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sccAnalysis1</span>, <span class="va">sccAnalysis2</span><span class="op">)</span></code></pre></div>
<p>Then create a list with all exposure outcome pairs to be analyzed. These can be concept IDs if you are using the condition_occurrence and drug_era tables or cohort IDs if you are using a cohort table for exposures and outcomes.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">exposureOutcomeList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/createExposureOutcome.html">createExposureOutcome</a></span><span class="op">(</span>exposureId <span class="op">=</span> <span class="fl">4</span>, outcomeId <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
                            <span class="fu"><a href="../reference/createExposureOutcome.html">createExposureOutcome</a></span><span class="op">(</span>exposureId <span class="op">=</span> <span class="fl">1</span>, outcomeId <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
  </code></pre></div>
<p>The total number of rate ratios will be <code>length(sccAnalysisList) * length(exposureOutcomesList)</code> since every analysis will be executed for every exposure-outcome pair.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R">    
<span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSccAnalyses.html">runSccAnalyses</a></span><span class="op">(</span><span class="va">connectionDetails</span>,
                          cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,
                          exposureTable <span class="op">=</span> <span class="st">"cohort"</span>,
                          outcomeTable <span class="op">=</span> <span class="st">"cohort"</span>,
                          outputFolder <span class="op">=</span> <span class="st">"./SelfControlledCohortOutput"</span>,
                          sccAnalysisList <span class="op">=</span> <span class="va">sccAnalysisList</span>,
                          exposureOutcomeList <span class="op">=</span> <span class="va">exposureOutcomeList</span>,
                          analysisThreads <span class="op">=</span> <span class="fl">1</span>,
                          computeThreads <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; *** Running multiple analysis ***</span>


<span class="fu"><a href="../reference/summarizeAnalyses.html">summarizeAnalyses</a></span><span class="op">(</span><span class="va">results</span>, <span class="st">"./SelfControlledCohortOutput"</span><span class="op">)</span>
<span class="co">#&gt;  [1] exposureId           outcomeId            numPersons          </span>
<span class="co">#&gt;  [4] numExposures         numOutcomesExposed   logRr               </span>
<span class="co">#&gt;  [7] seLogRr              numOutcomesUnexposed timeAtRiskExposed   </span>
<span class="co">#&gt; [10] timeAtRiskUnexposed  irr                  irrLb95             </span>
<span class="co">#&gt; [13] irrUb95              p                    analysisId          </span>
<span class="co">#&gt; &lt;0 rows&gt; (or 0-length row.names)</span></code></pre></div>
<p>Analysis result objects are saved to the output folder and are aggregated by the <code>summarizeAnalyses</code> function which returns a results dataframe with one row for each result.</p>
</div>
<div class="section level1">
<h1 id="correcting-bias-with-empiricalcalibration">Correcting bias with EmpiricalCalibration<a class="anchor" aria-label="anchor" href="#correcting-bias-with-empiricalcalibration"></a>
</h1>
<p>Effect estimates generated from observational data likely suffer from significant systematic bias. For example, this study design has the flaw that an exposure may look protective due to confounding by indication where patients are commonly exposed to a medication that is used to treat a comorbidity. For this reason, the <code>SelfControlledCohort</code> is often used with the <a href="https://github.com/OHDSI/EmpiricalCalibration" class="external-link"><code>EmpiricalCalibration</code></a> package to adjust effect estimates using negative control cohorts.</p>
<p>See <a href="https://github.com/OHDSI/MethodEvaulation" class="external-link"><code>MethodEvaulation</code></a> For more details on evaluating algorithms for population-level effect estimation in observational studies.</p>
<div style="margin-bottom:100px;">

</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jamie Gilbert, Martijn Schuemie, Patrick Ryan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
